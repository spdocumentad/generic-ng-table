<div class="mat-elevation-z2 smart-table-container">
  <!-- NEW: Floating Message Box (Simple modal replacement for limit exceeded warnings) -->
  @if (message()) {
  <div class="floating-message {{ message()?.type }}">
    {{ message()?.text }}
    <button class="close-button" (click)="clearMessage()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  }

  <table
    mat-table
    [dataSource]="tableData()"
    matSort
    [matSortActive]="sortState().key"
    [matSortDirection]="sortState().direction"
    class="full-width-table"
  >
    <!-- Column Definitions (Iterate over the full column configuration) -->
    @for (col of allColumnsConfig(); track col.field) {
    <ng-container matColumnDef="{{ col.field }}" [sticky]="col.sticky">
      <!-- Header Cell -->
      <!-- Use sticky property from the config -->
      <th
        mat-header-cell
        *matHeaderCellDef
        mat-sort-header="{{ col.field }}"
        [attr.mat-sort-start]="'asc'"
        [ngClass]="col.cssClasses"
        [disabled]="col.sortable === false"
        [matTooltip]="col.label + (col.sticky ? ' (Sticky)' : '')"
      >
        {{ col.label }}
      </th>
      <!-- Data Cell -->
      <td
        mat-cell
        *matCellDef="let element"
        [ngClass]="col.cssClasses"
        [style.justify-content]="col.alignment || 'flex-start'"
      >
        <!-- Render based on column type (basic logic) -->
        @switch (col.type) { @case ('boolean') {
        <mat-icon
          [color]="getCellValue(element, col) === 'true' ? 'primary' : 'warn'"
        >
          {{
            getCellValue(element, col) === "true" ? "check_circle" : "cancel"
          }}
        </mat-icon>
        } @case ('icon') {
        <mat-icon> {{ getCellValue(element, col) }} </mat-icon>
        }@case ('menu') {
        <!-- Three-dot menu for actions -->
        <button
          mat-icon-button
          [matMenuTriggerFor]="actionsMenu"
          (click)="openMenu($event, element)"
          aria-label="Row actions menu"
        >
          <mat-icon>more_vert</mat-icon>
        </button>
        } @default {
        {{ getCellValue(element, col) }}
        } }
      </td>
    </ng-container>
    }

    <!-- Header Row and Data Rows use the computed visibleColumnFields() -->
    <tr mat-header-row *matHeaderRowDef="visibleColumnFields()"></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: visibleColumnFields()"
      (click)="onRowClick(row)"
      [ngClass]="{ 'selected-row': isRowSelected(row) }"
    ></tr>

    <!-- Row shown when there is no data matching the filter (using @if / @empty) -->
    @if (tableData().length === 0) {
    <tr class="mat-row">
      <td class="mat-cell" [attr.colspan]="visibleColumnsConfig().length">
        No data matching the current filter criteria.
      </td>
    </tr>
    }
  </table>
</div>

<!-- Reusable Angular Material Menu Definition -->
<mat-menu #actionsMenu="matMenu">
  <!-- Iterate over the menuItems of the currently opened menu column.
         We must find the column that has type 'menu' and get its menuItems. 
         This assumes only one menu column is visible at a time. -->
  @for (col of visibleColumnsConfig(); track col.field) { @if (col.type ===
  'menu' && col.menuItems) { @for (item of col.menuItems; track item.label) {
  <button
    mat-menu-item
    (click)="executeAction(item)"
    [disabled]="isMenuItemDisabled(item)"
  >
    @if (item.icon) {
    <mat-icon>{{ item.icon }}</mat-icon>
    }
    <span>{{ item.label }}</span>
  </button>
  } } }
</mat-menu>
